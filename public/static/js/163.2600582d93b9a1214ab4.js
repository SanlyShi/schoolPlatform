webpackJsonp([163],{"1IlA":function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=i("3cXf"),s=i.n(a),r=i("C331"),n={props:{data:{default:null}},data:function(){return{teacher:null,showDetect:!1,formFields:{name:"",teacherName:"",classTime:"",peopleType:"ALL",activityPictures:[],applyAuditNeeded:!0,applyEndTime:"",applyStartTime:"",endTime:"",startTime:"",userLimit:""},detectShow:!1,pageStatus:{pageLayout:{groups:[{title:"",cells:[{title:"活动名称",name:"name",type:"input",required:!0},{title:"活动定位",name:"activityCategory",type:"radio",required:!0}]},{title:"",cells:[{title:"任课教师",name:"teacherName",type:"detect",required:!1},{title:"上课时间",name:"classTime",type:"input",required:!1}]},{title:"",cells:[{title:"发布方",name:"publisher",type:"radio",required:!0},{title:"主办方",name:"holder",type:"radio",required:!0},{title:"承办方",name:"organizer",type:"radio",required:!1},{title:"协办方",name:"coOrganizer",type:"radio",required:!1}]},{title:"",cells:[{title:"活动封面",name:"activityCover",type:"image",required:!1},{title:"活动图片",name:"activityPictures",type:"images",required:!1},{title:"活动简介",name:"introduction",type:"textarea",max:1e3,required:!0},{title:"活动类型",name:"activityType",type:"tree",required:!0},{title:"活动积分",name:"treePoint",type:"text",required:!1}]},{title:"",cells:[{title:"报名开始时间",name:"applyStartTime",type:"datetime",start:"",end:"applyEndTime",required:!0},{title:"报名结束时间",name:"applyEndTime",type:"datetime",start:"applyStartTime",end:"endTime",required:!0},{title:"活动开始时间",name:"startTime",type:"datetime",start:"applyStartTime",end:"endTime",required:!0},{title:"活动结束时间",name:"endTime",type:"datetime",start:"startTime",end:"",required:!0},{title:"活动地点",name:"place",type:"textarea",max:50,required:!0},{title:"联系方式",name:"telephoneNumber",type:"input",required:!0}]},{title:"",cells:[{title:"面向群体",name:"peopleType",type:"radio",required:!0},{hide:!0,title:"",name:"peopleList",type:"checkbox",required:!1},{title:"人数上限",name:"userLimit",type:"number",required:!1},{title:"报名是否审核",name:"applyAuditNeeded",type:"radio",required:!0}]}]},pageOptions:{applyAuditNeeded:[{key:!0,value:"是"},{key:!1,value:"否"}],peopleType:[{key:"ALL",value:" 全体"},{key:"GRADE",value:"年级"},{key:"COLLEGE",value:"学院"}],peopleList:[],collegesList:[],gradesList:[]},editingField:{},checkShow:!1,myCroppa:{},imageCut:{width:360,height:130,start:!1,imageUrl:"",cell:{}}},isChange:!1}},watch:{historyForm:{handler:function(e,t){e!==t&&(this.isChange=!0)},deep:!0},changePeople:function(e,t){this.pageStatus.pageLayout.groups[5].cells[1].hide=!0,this.pageStatus.pageOptions.peopleList=[],"ALL"!==e&&(this.pageStatus.pageLayout.groups[5].cells[1].hide=!1,this.pageStatus.pageOptions.peopleList="COLLEGE"==e?this.pageStatus.pageOptions.collegesList:this.pageStatus.pageOptions.gradesList)}},computed:{changePeople:function(){return this.formFields.peopleType},republish:function(){return!!this.data.data.initData},historyForm:function(){return s()(this.formFields)},selectPoint:function(){if(this.formFields.activityType&&this.pageStatus.pageOptions.activityType)for(var e in this.pageStatus.pageOptions.activityType)if(this.formFields.activityType[1]===this.pageStatus.pageOptions.activityType[e].value)return this.pageStatus.pageOptions.activityType[e].point;return 0}},created:function(){this._getPublishers(),this._getHolders(),this._getGroups(),this._getContentTypes(),this._getActivityTypes(),this.getCollegesList(),this.getGradesList(),this.republish&&this._initPublish(this.data.data.initData)},methods:{_detect:function(e){this.teacher=e},modalCancel:function(){this.teacher=null,this.showDetect=!1},modalSure:function(){this.formFields.teacherId=this.teacher.userId,this.formFields.userNo=this.teacher.userNo,this.formFields.teacherName=this.teacher.name,this.showDetect=!1},_initPublish:function(e){var t=this;for(var i in e)this.$set(this.formFields,i,e[i]);e.organizations.forEach(function(e){"PUBLISHER"===e.type?t.$set(t.formFields,"publisher",e.organizationId):"SPONSOR"===e.type?(t.formFields.holder||t.$set(t.formFields,"holder",[]),t.formFields.holder.push(e.organizationId)):"PURVEYOR"===e.type?(t.formFields.organizer||t.$set(t.formFields,"organizer",[]),t.formFields.organizer.push(e.organizationId)):"ASSISTANT"===e.type&&(t.formFields.coOrganizer||t.$set(t.formFields,"coOrganizer",[]),t.formFields.coOrganizer.push(e.organizationId))}),this.$set(this.formFields,"studentOriented",[]),e.studentOriented.forEach(function(e){t.formFields.studentOriented.push(e.code+"")}),e.images.forEach(function(e){e.isCover?t.$set(t.formFields,"activityCover",e.image):(t.formFields.activityPictures||t.$set(t.formFields,"activityPictures",[]),t.formFields.activityPictures.push(e.image))}),this.$set(this.formFields,"activityType",[e.contentTypeParentId+"",e.contentTypeId+""]),this.$set(this.formFields,"activityCategory",e.typeId),this.$set(this.formFields,"telephoneNumber",e.contactWay),this.$set(this.formFields,"id",e.id+"")},_checkVal:function(e){/^\d+(\.{0,1}\d+){0,1}$/.test(this.formFields[e.name])||(this.formFields[e.name]="")},_getHourMinuteList:function(e){for(var t=0,i=0,a=this.formFields[e.start],s=this.formFields[e.end],r={hourList:[],minuteList:[]},n=0;n<24;n++)r.hourList.push(("0"+n).slice(-2));for(var o=0;o<24;o++)r.minuteList.push(("0"+o).slice(-2));if(!a)return r;if(t=parseInt(a.slice(10,13)),i=parseInt(a.slice(13,16)),a=new Date(a.replace(/\-\g/,"/")).getTime(),!s)return r;parseInt(s.slice(10,13)),parseInt(a.slice(13,16));var l=((s=new Date(s.replace(/\-\g/,"/")).getTime())-a)/36e5,p=(s-a)/6e4;if(l<24){r.hourList=[];for(var u=0;u<l;u++)r.hourList.push(("0"+(t+u>23?t+u-24:t+u)).slice(-2))}if(p<60){r.minuteList=[];for(var c=0;c<p;c++)r.minuteList.push(("0"+(i+c>59?i+c-60:i+c)).slice(-2))}return r},_valueChange:function(e,t){var i=this,a=this.formFields[t.start],s=this.formFields[t.end],r=0,n=0,o=new Date(e.replace(/\-\g/,"/")).getTime(),l="";if(a&&(r=new Date(a.replace(/\-\g/,"/")).getTime()),s&&(n=new Date(s.replace(/\-\g/,"/")).getTime()),a&&o<=r&&(l="选择的时间要在"+a+"之后！"),s&&o>=n&&(l="选择的时间要在"+s+"之前！"),"endTime"===t.name){var p=this.formFields.applyEndTime,u=p?new Date(p.replace(/\-\g/,"/")).getTime():0;u&&o<=u&&(l="选择的时间要在"+p+"之后！")}l&&(setTimeout(function(){i.formFields[t.name]=""},100),this.$vux.alert.show({title:l}))},_startCut:function(e,t){if(e.target.files[0]){var i=this;this.pageStatus.imageCut.start=!0,this.pageStatus.imageCut.cell=t;var a=new FileReader;a.onloadend=function(e){i.pageStatus.imageCut.imageUrl=e.target.result},a.readAsDataURL(e.target.files[0]),e.target.value=""}},_endCut:function(e){if(e){var t=this.pageStatus.myCroppa.generateDataUrl("image/jpeg",.52);this._uploadImages(t,this.pageStatus.imageCut.cell,"base64")}this.pageStatus.imageCut.start=!1,this.pageStatus.imageCut.imageUrl="",this.pageStatus.cell={}},_removeImage:function(e,t){var i=this;this.$vux.confirm.show({title:"确定删除该图片吗？",onConfirm:function(){i.formFields[e].splice(t,1)}})},_uploadImages:function(e,t,i){var a=this,s="",n={};"base64"===i?(n.data=e,s=this.uploadBase64):((n=new FormData).append("file",e.target.files[0]),e.target.value="",s=this.uploadImage),Object(r.e)({url:s,type:"post",data:n,processData:"base64"===i,contentType:"base64"===i,success:function(e){"88888"===e.code||e.state?"images"===t.type?(a.formFields[t.name]||a.$set(a.formFields,t.name,[]),a.formFields[t.name].push(e.data.hash)):"image"===t.type&&a.$set(a.formFields,t.name,e.data.hash):a._toast(e.message)}})},_getNameStr:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"key",a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"value",s="";return this.pageStatus.pageOptions[e.name]&&this.pageStatus.pageOptions[e.name].length>0&&this.formFields[e.name]&&this.formFields[e.name].forEach(function(r){t.pageStatus.pageOptions[e.name].forEach(function(e){r===e[i]&&(s+=" "+e[a])})}),s},_focus:function(e){this.pageStatus.editingField=e,["checkbox"].indexOf(e.type)>=0&&(this.pageStatus.checkShow=!0)},_back:function(e){var t=this;this.isChange?this.$vux.confirm.show({title:"返回将会丢失编辑内容，是否返回？",onConfirm:function(){t.$emit("removeBread",t.data)}}):this.$emit("removeBread",this.data)},_submit:function(){var e=this;this._verify().length>0?this._toast("请完善活动信息！"):this.$vux.confirm.show({title:"确定提交活动内容等候审核?",onConfirm:function(){var t=e._format(e.formFields);Object(r.e)({url:"/api/sc/activities"+(e.republish?"/"+e.formFields.id:""),type:"post",data:t,success:function(t){t.state?e._toast("发布成功",function(){e.data.isUpdateLastPage=!0,e.$emit("removeBread",e.data)}):e._toast(t.message)}})}})},_verify:function(){var e=this,t=[];return this.pageStatus.pageLayout.groups.forEach(function(i){i.cells.forEach(function(i){i.required&&(e.formFields[i.name]||t.push(i.title))})}),t},_format:function(e){var t=JSON.parse(s()(e));t.organizations=[],t.publisher&&t.organizations.push({organizationId:t.publisher,type:"PUBLISHER"}),delete t.publisher,t.holder&&t.organizations.push({organizationId:t.holder,type:"SPONSOR"}),delete t.holder,t.organizer&&t.organizations.push({organizationId:t.organizer,type:"PURVEYOR"}),delete t.organizer,t.coOrganizer&&t.organizations.push({organizationId:t.coOrganizer,type:"ASSISTANT"}),delete t.coOrganizer;var i=[];return t.peopleList&&t.peopleList.forEach(function(e){i.push({code:e})}),t.studentOriented=[],t.grade=[],"COLLEGE"==t.peopleType?t.studentOriented=i:"GRADE"==t.peopleType&&(t.grade=t.peopleList),t.images=[],t.activityCover&&t.images.push({image:t.activityCover,isCover:!0}),delete t.activityCover,t.activityPictures&&t.activityPictures.forEach(function(e){t.images.push({image:e,isCover:!1})}),delete t.activityPictures,t.activityType&&(t.contentTypeId=t.activityType[1]),delete t.activityType,t.activityCategory&&(t.typeId=t.activityCategory),delete t.activityCategory,t.telephoneNumber&&(t.contactWay=t.telephoneNumber),delete t.telephoneNumber,t},_getPublishers:function(){var e=this;this.pageStatus.pageOptions.publisher||this.$set(this.pageStatus.pageOptions,"publisher",[]),this.data.data&&this.data.data.publishers&&this.data.data.publishers.forEach(function(t){var i={key:t.id,value:t.name};e.pageStatus.pageOptions.publisher.push(i)})},_getHolders:function(){var e=this;Object(r.e)({url:"/api/sc/organizations/list/brief",type:"get",success:function(t){if(t.state){if(e.pageStatus.pageOptions.holder||e.$set(e.pageStatus.pageOptions,"holder",[]),e.pageStatus.pageOptions.organizer||e.$set(e.pageStatus.pageOptions,"organizer",[]),e.pageStatus.pageOptions.coOrganizer||e.$set(e.pageStatus.pageOptions,"coOrganizer",[]),t.data){var i=[];t.data.forEach(function(e){var t={key:e.id,value:e.name};i.push(t)}),e.pageStatus.pageOptions.holder=i,e.pageStatus.pageOptions.organizer=i,e.pageStatus.pageOptions.coOrganizer=i}}else e._toast("举办方列表获取失败")}})},_getGroups:function(){var e=this;Object(r.e)({url:"/api/colleges",type:"get",success:function(t){t.state?(e.pageStatus.pageOptions.studentOriented||e.$set(e.pageStatus.pageOptions,"studentOriented",[]),t.data&&t.data.forEach(function(t){var i={key:t.code,value:t.name};e.pageStatus.pageOptions.studentOriented.push(i)})):e._toast("群体列表获取失败")}}),this.pageStatus.pageOptions},getCollegesList:function(){var e=this;Object(r.d)("/api/colleges").then(function(t){e.pageStatus.pageOptions.collegesList=[],t.state&&t.data.map(function(t,i){e.pageStatus.pageOptions.collegesList.push({key:t.code,value:t.name})})})},getGradesList:function(){var e=new Date,t=e.getFullYear();t=e.getMonth()+1<7?t-1:t;for(var i=0;i<5;i++)this.pageStatus.pageOptions.gradesList.push({key:""+(t-i),value:t-i+"级"})},_getContentTypes:function(){var e=this;Object(r.e)({url:"/api/sc/activityContentType",type:"get",success:function(t){t.state?(e.pageStatus.pageOptions.activityType||e.$set(e.pageStatus.pageOptions,"activityType",[]),t.data&&t.data.forEach(function(t){var i={value:t.id+"",name:t.typeName,parent:0};t.childType.length>0&&e.pageStatus.pageOptions.activityType.push(i),t.childType.length>0&&t.childType.forEach(function(i){var a={value:i.id+"",name:i.typeName,parent:t.id+"",point:i.point};e.pageStatus.pageOptions.activityType.push(a)})})):e._toast("活动类型列表获取失败")}})},_getActivityTypes:function(){var e=this;Object(r.e)({url:"/api/sc/activities/types",type:"get",success:function(t){t.state?(e.pageStatus.pageOptions.activityCategory||e.$set(e.pageStatus.pageOptions,"activityCategory",[]),t.data&&t.data.forEach(function(t){var i={key:t.id,value:t.name};e.pageStatus.pageOptions.activityCategory.push(i)})):e.$vux.toast.show({text:t.message,position:"bottom",type:"text"})}})},_toast:function(e,t){this.$vux.toast.show({text:e,position:"bottom",type:"text",time:1500,onHide:t})}},mounted:function(){}},o={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{attrs:{id:"activityPublish"}},[a("view-box",[a("x-header",{attrs:{title:"发布活动"}},[a("i",{staticClass:"maticon back-icon",attrs:{slot:"overwrite-left"},domProps:{innerHTML:e._s(e.icons("navigate_before"))},on:{click:e._back},slot:"overwrite-left"},[e._v("navigate_before")])]),e._v(" "),a("div",{staticClass:"publish-content"},[e._l(e.pageStatus.pageLayout.groups,function(t,s){return a("group",{key:s,staticClass:"info-group",attrs:{title:t.title,"label-width":"8em","label-margin-right":"2em","label-align":"left"}},e._l(t.cells,function(t,s){return a("group",{key:s,staticStyle:{position:"relative"}},[a("div",{staticClass:"require"},[e._v(e._s(t.required?"*":""))]),e._v(" "),["input"].indexOf(t.type)>=0?a("x-input",{ref:t.name+"_input",refInFor:!0,attrs:{title:t.title,"show-clear":!1,placeholder:"请输入",max:t.max,"text-align":"right"},model:{value:e.formFields[t.name],callback:function(i){e.$set(e.formFields,t.name,i)},expression:"formFields[cell.name]"}}):["number"].indexOf(t.type)>=0?a("x-input",{attrs:{title:t.title,"show-clear":!1,placeholder:"请输入","text-align":"right",type:"text",debounce:500},nativeOn:{change:function(i){return e._checkVal(t)}},model:{value:e.formFields[t.name],callback:function(i){e.$set(e.formFields,t.name,i)},expression:"formFields[cell.name]"}}):["tel"].indexOf(t.type)>=0?a("x-input",{attrs:{title:t.title,"show-clear":!1,placeholder:"请输入","text-align":"right","is-type":"china-mobile"},model:{value:e.formFields[t.name],callback:function(i){e.$set(e.formFields,t.name,i)},expression:"formFields[cell.name]"}}):["textarea"].indexOf(t.type)>=0?a("x-textarea",{class:{textarea:!e.formFields[t.name]},attrs:{title:t.title,placeholder:"请输入",max:t.max},model:{value:e.formFields[t.name],callback:function(i){e.$set(e.formFields,t.name,i)},expression:"formFields[cell.name]"}}):"datetime"===t.type?a("datetime",{attrs:{title:t.title,placeholder:"请选择","value-text-align":"right",format:"YYYY-MM-DD HH:mm"},on:{"on-change":function(i){return e._valueChange(i,t)}},model:{value:e.formFields[t.name],callback:function(i){e.$set(e.formFields,t.name,i)},expression:"formFields[cell.name]"}}):"radio"===t.type?a("popup-radio",{attrs:{"arrow-direction":"",title:t.title,options:e.pageStatus.pageOptions[t.name]||[],placeholder:"请选择","value-text-align":"right"},model:{value:e.formFields[t.name],callback:function(i){e.$set(e.formFields,t.name,i)},expression:"formFields[cell.name]"}}):"tree"===t.type?a("popup-picker",{ref:t.name+"_picker",refInFor:!0,attrs:{"arrow-direction":"",title:t.title,data:e.pageStatus.pageOptions[t.name]||[],columns:2,placeholder:"请选择","value-text-align":"right","show-name":""},model:{value:e.formFields[t.name],callback:function(i){e.$set(e.formFields,t.name,i)},expression:"formFields[cell.name]"}}):e.formFields.activityType&&"treePoint"===t.name?a("x-input",{attrs:{title:t.title,value:e.selectPoint,readonly:"true","text-align":"right",type:"text"}}):!t.hide&&["checkbox"].indexOf(t.type)>=0?a("x-input",{attrs:{title:t.title,readonly:"",placeholder:"studentOriented"===t.name?"全校":"请选择",value:e._getNameStr(t),"text-align":"right"},on:{"on-focus":function(i){return e._focus(t)}}}):"image"===t.type?a("div",{staticClass:"weui-cell image"},[a("label",{staticClass:"title"},[e._v(e._s(t.title))]),e._v(" "),a("div",{staticClass:"img-body"},[e.formFields[t.name]?a("div",{staticClass:"img-item-cover"},[a("img",{attrs:{src:e.imageUrlPrefix+e.formFields[t.name],alt:""}}),e._v(" "),a("input",{attrs:{type:"file"},on:{change:function(i){return e._startCut(i,t)}}})]):a("div",{staticClass:"choose-img"},[a("img",{attrs:{src:i("hw6C"),alt:""}}),e._v(" "),a("input",{attrs:{type:"file"},on:{change:function(i){return e._startCut(i,t)}}})])])]):"images"===t.type?a("div",{staticClass:"weui-cell images"},[a("label",{staticClass:"title"},[e._v(e._s(t.title))]),e._v(" "),a("div",{staticClass:"box_flex"},[e._l(e.formFields[t.name],function(i,s){return a("x-img",{key:s,staticClass:"img-item",attrs:{src:e.imageUrlPrefix+i},nativeOn:{click:function(i){return i.stopPropagation(),e._removeImage(t.name,s)}}})}),e._v(" "),a("div",{staticClass:"choose-img"},[a("img",{attrs:{src:i("hw6C"),alt:""}}),e._v(" "),a("input",{attrs:{type:"file"},on:{change:function(i){return e._uploadImages(i,t)}}})])],2)]):"detect"===t.type?a("cell",{attrs:{title:t.title,value:e.formFields[t.name]||"请输入"},nativeOn:{click:function(t){e.showDetect=!0}}}):e._e()],1)}),1)}),e._v(" "),a("box",{staticClass:"submit-box"},[a("x-button",{staticClass:"custom-primary-blue",attrs:{plain:"",type:"primary"},nativeOn:{click:function(t){return e._submit(t)}}},[e._v("发布活动")])],1),e._v(" "),a("div",{directives:[{name:"transfer-dom",rawName:"v-transfer-dom"}]},[a("popup",{staticClass:"act-modal-wrap",attrs:{height:"100%","is-transparent":""},model:{value:e.showDetect,callback:function(t){e.showDetect=t},expression:"showDetect"}},[a("div",{staticClass:"act-modal"},[a("div",{staticClass:"body"},[a("detect",{staticClass:"form-control search-input modal-form-style",attrs:{url:"/api/users/search",searchVal:e.formFields.userNo?e.formFields.teacherName+"("+e.formFields.userNo+")":"",type:"query"},on:{afterSelected:e._detect}})],1),e._v(" "),a("div",{staticClass:"bottom"},[a("div",{staticClass:"act-btn",on:{click:e.modalCancel}},[e._v("取消")]),e._v(" "),a("div",{staticClass:"act-btn sure",on:{click:e.modalSure}},[e._v("确定")])])])])],1),e._v(" "),a("div",{directives:[{name:"transfer-dom",rawName:"v-transfer-dom"}]},[a("popup",{attrs:{position:"bottom","max-height":"70%"},model:{value:e.pageStatus.checkShow,callback:function(t){e.$set(e.pageStatus,"checkShow",t)},expression:"pageStatus.checkShow"}},[a("group",{attrs:{title:e.formFields[e.pageStatus.editingField.name]&&e.formFields[e.pageStatus.editingField.name].length>0?"已选择"+e.formFields[e.pageStatus.editingField.name].length+"项":e.pageStatus.editingField.title}},[e.pageStatus.checkShow?a("checklist",{attrs:{options:e.pageStatus.pageOptions[e.pageStatus.editingField.name]||[]},model:{value:e.formFields[e.pageStatus.editingField.name],callback:function(t){e.$set(e.formFields,e.pageStatus.editingField.name,t)},expression:"formFields[pageStatus.editingField.name]"}}):e._e()],1)],1)],1),e._v(" "),a("div",{directives:[{name:"transfer-dom",rawName:"v-transfer-dom"}]},[a("popup",{staticClass:"cut-wrap",attrs:{height:"100%"},model:{value:e.pageStatus.imageCut.start,callback:function(t){e.$set(e.pageStatus.imageCut,"start",t)},expression:"pageStatus.imageCut.start"}},[a("croppa",{staticClass:"cut",attrs:{width:e.pageStatus.imageCut.width,height:e.pageStatus.imageCut.width/2,"initial-image":e.pageStatus.imageCut.imageUrl,"show-remove-button":!1,"disable-click-to-choose":!1},model:{value:e.pageStatus.myCroppa,callback:function(t){e.$set(e.pageStatus,"myCroppa",t)},expression:"pageStatus.myCroppa"}},[a("img",{attrs:{slot:"initial",src:e.pageStatus.imageCut.imageUrl},slot:"initial"})]),e._v(" "),a("div",{staticClass:"cut-wrap"},[a("x-button",{style:"width:"+e.pageStatus.imageCut.width+"px;",attrs:{type:"warn"},nativeOn:{click:function(t){return e._endCut(!1)}}},[e._v("取消")]),e._v(" "),a("x-button",{style:"width:"+e.pageStatus.imageCut.width+"px;",attrs:{type:"primary"},nativeOn:{click:function(t){return e._endCut(!0)}}},[e._v("确定")])],1)],1)],1)],2)],1)],1)},staticRenderFns:[]};var l=i("C7Lr")(n,o,!1,function(e){i("SxcJ")},null,null);t.default=l.exports},SxcJ:function(e,t){}});